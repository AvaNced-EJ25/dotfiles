# vim: syntax=bash

export ZDOTDIR="${HOME}/.config/zsh"

# set PATH so it includes user's private bin if it exists
if [ -d "$HOME/bin" ] && ! [[ "$PATH" == *"$HOME/bin"* ]]; then
    PATH="$HOME/bin:$PATH"
fi

# set PATH so it includes user's private bin if it exists
if [ -d "$HOME/.local/bin" ] && ! [[ "$PATH" == *"$HOME/.local/bin"* ]]; then
    PATH="$HOME/.local/bin:$PATH"
fi

# Add brew to the shell
test -d ~/.linuxbrew && eval "$(~/.linuxbrew/bin/brew shellenv)"
test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
test -d /opt/homebrew/ && eval "$(/opt/homebrew/bin/brew shellenv)"

if type brew &>/dev/null; then
    FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi

# Download zinit if needed
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
[ ! -d $ZINIT_HOME ] && mkdir -p "$(dirname $ZINIT_HOME)"
[ ! -d $ZINIT_HOME/.git ] && git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
source "${ZINIT_HOME}/zinit.zsh"

# Download the Catppuccin theme for zsh if needed
CATPPUCCIN_THEME="${ZDOTDIR:-~}/funcs/catppuccin_macchiato-zsh-syntax-highlighting.zsh"

if [ ! -f $CATPPUCCIN_THEME ]; then
    wget --output-document="${CATPPUCCIN_THEME}" https://github.com/catppuccin/zsh-syntax-highlighting/raw/main/themes/catppuccin_macchiato-zsh-syntax-highlighting.zsh
fi

fpath+=${ZDOTDIR:-~}/.zsh_completions

# Load aliases file (need brew in the path first)
source "${HOME}/.config/aliases.sh"

# Add lesspipe
[ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

if type fzf &> /dev/null; then
export FZF_BASE="$(which fzf)"
fi

# Preview file content using bat (https://github.com/sharkdp/bat)
export FZF_CTRL_T_OPTS="
    --walker-skip .git,node_modules,target
    --preview 'bat -n --color=always {}'
    --bind 'ctrl-/:change-preview-window(down|hidden|)'"

# CTRL-Y to copy the command into clipboard using pbcopy
export FZF_CTRL_R_OPTS="
  --bind 'ctrl-y:execute-silent(echo -n {2..} | clip-set)+abort'
  --color header:italic
  --header 'Press CTRL-Y to copy command into clipboard'"

# Print tree structure in the preview window
export FZF_ALT_C_OPTS="
  --walker-skip .git,node_modules,target
  --preview 'eza --tree --icons=auto --classify=auto {}'"

export FZF_DEFAULT_OPTS=" \
    --color=bg+:#363a4f,bg:#24273a,spinner:#f4dbd6,hl:#ed8796 \
    --color=fg:#cad3f5,header:#ed8796,info:#c6a0f6,pointer:#f4dbd6 \
    --color=marker:#b7bdf8,fg+:#cad3f5,prompt:#c6a0f6,hl+:#ed8796 \
    --color=selected-bg:#494d64 \
    --multi"

export ZOXIDE_CMD_OVERRIDE="cd"

zstyle ':omz:plugins:eza' 'dirs-first' yes
zstyle ':omz:plugins:eza' 'header' yes
zstyle ':omz:plugins:eza' 'icons' yes
zstyle ':omz:plugins:eza' 'color-scale' all
zstyle ':omz:plugins:eza' 'color-scale-mode' gradient
zstyle ':omz:plugins:eza' 'hyperlink' yes

# Plugins
zinit light lukechilds/zsh-better-npm-completion
zinit light zsh-users/zsh-completions
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-syntax-highlighting
zinit light andlebed/zsh-fnm

# OMZ Pluggins
omzp=( chezmoi docker docker-compose eza fzf git kitty npm rust sudo uv yarn zoxide )

for plug in $omzp; do
    zinit snippet "OMZP::${plug}/${plug}.plugin.zsh"
done

alias ltree="eza --tree --long --header --icons=auto --classify=auto --hyperlink"
alias tree="eza --tree --icons=auto --classify=auto --hyperlink"
alias -g -- -h='-h 2>&1 | bat --language=help --style=plain'
alias -g -- --help='--help 2>&1 | bat --language=help --style=plain'

if [[ $COLORTERM =~ ^(truecolor|24bit)$ ]]; then
    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#f5bde6"
fi

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

alias keepassxc-cli="flatpak run org.keepassxc.KeePassXC cli"

# set PATH so it includes spicetify
if [ -d "$HOME/.spicetify" ]; then
    PATH="$PATH:$HOME/.spicetify"
fi

# Set pager to nvim
export MANPAGER='nvim +Man!'

export HOMEBREW_NO_ENV_HINTS=1
export HOMEBREW_AUTO_UPDATE_SECS='86400'

# Source all zsh files
for z in ${ZDOTDIR:-~}/funcs/*.zsh; do
    source $z
done

# Lines configured by zsh-newuser-install
HISTFILE=${ZDOTDIR:-~}/histfile
HISTSIZE=5000
SAVEHIST=5000
HISTDUP=erase
setopt autocd beep nomatch appendhistory sharehistory hist_ignore_space hist_ignore_all_dups hist_save_no_dups hist_ignore_dups hist_find_no_dups INC_APPEND_HISTORY COMPLETE_IN_WORD
bindkey -v

# Keybinds
bindkey '^p' history-search-backward
bindkey '^n' history-search-forward
bindkey '^H' backward-kill-word
bindkey '^\' autosuggest-accept
bindkey '^[\' autosuggest-clear

# End of lines configured by zsh-newuser-install
# The following lines were added by compinstall
zstyle :compinstall filename "${ZDOTDIR}/.zshrc"

autoload -Uz compinit bashcompinit
compinit
bashcompinit

zinit ice atload"zpcdreplay" atclone"./zplug.zsh" atpull"%atclone"
zinit light g-plane/pnpm-shell-completion

# End of lines added by compinstall

# Add oh-my-posh prompt
eval "$(oh-my-posh init zsh --config "${OH_MY_POSH_CONFIG}")"

# pnpm
if [ -d "${HOME}/.local/share/pnpm" ]; then
    export PNPM_HOME="${HOME}/.local/share/pnpm"

    case ":$PATH:" in
      *":$PNPM_HOME:"*) ;;
      *) export PATH="$PNPM_HOME:$PATH" ;;
    esac
fi
# pnpm end
